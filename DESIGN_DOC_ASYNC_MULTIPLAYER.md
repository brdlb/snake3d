# Дизайн-документ: Асинхронный Мультиплеер (Snake 3D)

## 1. Общая концепция
**Жанр:** Асинхронный аркадный мультиплеер.  
**Суть:** Игроки попадают в процедурно-генерируемые комнаты и соревнуются не напрямую друг с другом, а с «фантомами» — записями лучших игр предыдущих игроков в этой же комнате. Такой подход создает ощущение живого, наполненного мира без необходимости синхронного онлайн-соединения.

---

## 2. Генерация мира и Спавн

### 2.1. Комната и Сид
*   Каждая игра проходит в **Комнате**, которая полностью определяется уникальным **сидом (seed)**.
*   **Генерация еды:** Расположение еды генерируется детерминировано на основе сида. Это гарантирует, что все игроки в пределах одной «версии» комнаты находятся в равных условиях относительно ресурсов.
    *   *Синхронность целей:* Фантомы хранятся строго в пределах своего сида. Так как генерация еды идентична для всех запусков с одним сидом, фантомы на экране будут преследовать (и есть) ту же еду, которую видит живой игрок. Их движения остаются осмысленными (они не гоняются за "невидимой" едой из параллельной вселенной).
*   **Эволюция комнаты:** Комната накапливает историю. Новые игроки видят записи старых.

### 2.2. Механика возрождения (Respawn)
*   **Точки старта:** Игрок появляется не в самих углах куба (чтобы избежать мгновенной смерти или тупиков), а на отдалении (например, 5 блоков от угла).
*   **Ориентация:** Вектор движения на старте направлен **от ближайшей стены** к центру или вдоль безопасной траектории.
*   **Пресеты спавна:** Используется набор предопределенных точек спавна и ориентаций, чтобы гарантировать честный старт.

---

## 3. Механика Фантомов (Запись и Воспроизведение)

### 3.1. Компактная запись (Replay System)
Вместо покадровой записи позиции, сохраняется только **последовательность изменений состояний**.  
Формат данных одной сессии:
1.  `Seed` (Сид комнаты).
2.  `StartPoint` (ID точки спавна).
3.  `InputLog`: Массив событий `[Tick, NewDirection]`.
    *   Где *Tick* — время/кадр игрового цикла.
    *   *NewDirection* — вектор поворота.

*Преимущество:* Экстремально малый размер файла (несколько килобайт на игру), что позволяет хранить тысячи игр на сервере.

### 3.2. Взаимодействие
*   При входе в комнату клиент загружает **N** записей (фантомов) с сервера.
*   Фантомы материализуются и проигрывают свои записанные движения.
*   **Коллизии:**
    *   **Игрок vs Фантом:** Смертельно для игрока.
    *   **Фантом vs Фантом:** Фантомы могут врезаться друг в друга.
    *   *Решение для играбельности:* **Обновлено:** Фантомы материальны для всех. Если фантом врезается в игрока или другого фантома — это фатально для того, кто врезался (врезавшийся умирает). Это добавляет элемент хаоса и живой экосистемы, где даже записанные "прошлые я" могут уничтожить друг друга, если их пути пересекутся в новой итерации комнаты.

---

## 4. Жизненный цикл Комнаты (Server Logic)

### 4.1. Правила входа
*   **One Attempt:** Каждый игрок может сыграть в конкретной версии комнаты (конкретном сиде) **только один раз**. Это повышает ставки и ценность каждой попытки.

### 4.2. Ротация Фантомов ("Вытеснение")
Сервер хранит ограниченный набор лучших игр для каждой комнаты (например, слот под 4 фантома).
*   **Условие заполнения:** Если в комнате < 4 фантомов, запись игрока добавляется автоматически (при условии минимальной валидности).
*   **Конкуренция:** Если в комнате уже 4 фантома:
    1.  Игрок играет сессию против этих 4-х.
    2.  По завершении игры его счет сравнивается со счетами фантомов.
    3.  **Замена:** Если счет игрока **выше**, чем у самого слабого фантома, то запись слабейшего удаляется, а запись нового игрока занимает его место.
    
*Результат:* Сложность комнаты растет эволюционно. Сначала там случайные новички, со временем — только профессионалы, проложившие идеальные маршруты.

---

## 5. Техническая реализация (Draft)

### 5.1. Хранение данных (File System + JSON)
Для упрощения отладки и управления, данные хранятся в виде иерархии папок и JSON-файлов.

**Структура директорий:**
```text
/data
  /rooms
    /<seed_id>/            # Папка конкретной комнаты (напр. "seed_884422")
      meta.json            # Манифест комнаты: список активных фантомов
      replays/             # Папка со всеми записями (или просто файлы в корне)
        replay_<id>.json   # Полный лог конкретной игры
```

**Формат `meta.json`:**
Этот файл определяет, какие именно записи являются "активными" (попадут в игру к следующему игроку).
```json
{
  "seed": "884422",
  "total_games_played": 142,
  "active_phantoms": [
    { 
      "replayId": "replay_userA_123", 
      "score": 1500,
      "deathTick": 450 
    },
    { 
      "replayId": "replay_userB_456", 
      "score": 1200, 
      "deathTick": 300 
    }
  ]
}
```

**Формат файла реплея (`replay_<id>.json`):**
```json
{
  "id": "replay_userA_123",
  "playerId": "user_a",
  "timestamp": 1702480000,
  "startParams": {
    "seed": 884422,
    "spawnIndex": 1
  },
  "finalScore": 1500,
  "inputLog": [
    [10, "UP"],
    [45, "LEFT"], 
    [48, "UP"]
  ]
}
```
*Логика:* При входе игрока сервер читает `meta.json`, берет список `active_phantoms`, загружает соответствующие файлы json и отдает их клиенту. Если игрок побил рекорд — создается новый файл `replay_....json`, а `meta.json` обновляется.

### 5.2. Потенциальные проблемы и решения
1.  **Проблема:** "Слишком тесная комната". Если 4 фантома — это длинные змейки, живому игроку негде будет ползать.
    *   *Решение:* Балансировать размер карты или уменьшать кол-во фантомов в зависимости от их суммарной длины.
2.  **Проблема:** "Синхронизация". Если клиент и сервер имеют разную логику (тик-рейт), реплей "разъедется" (wall collision там, где его не было).
    *   *Решение:* Строго детерминированная логика (fixed timestep) на клиенте. Валидация хеша пути на сервере.

---

## 6. Оценка концепта
**Рейтинг:** ВЫСОКИЙ ПОТЕНЦИАЛ.

**Почему это круто:**
1.  **Ощущение толпы (MMO-like):** Игрок не одинок, но нет проблем с сетевым лагом (так как данные предзагружены).
2.  **Эволюция сложности:** Уровни сами себя балансируют под "топ" игроков.
3.  **Азарт:** "Один шанс на комнату" заставляет играть максимально сосредоточенно.

**Риски:**
*   В 3D Snake ориентация и навигация сложны. 4 хаотично движущихся фантома могут создать слишком высокий визуальный шум, делая игру неиграбельной ("непонятно куда ползти").
*   *Рекомендация:* Добавить визуальное отличие фантомов (полупрозрачные, "призрачные" шейдеры), чтобы игрок интуитивно отличал их от себя и стен.
